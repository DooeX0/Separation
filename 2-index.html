<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Separation</title>
    <link
      href="style.css"
      href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="tabs">
      <div class="tab active" onclick="switchTab('split')">Разделение</div>
      <div class="tab" onclick="switchTab('compress')">Сжатие</div>
    </div>

    <div class="workspace active" id="tab-split">
      <div class="pane">
        <textarea
          id="split-input"
          oninput="
            processSplit();
            save();
          "
        ></textarea>
      </div>
      <div class="pane">
        <div class="output" id="split-output"></div>
        <button class="copy-btn" onclick="copyOutput('split-output')">
          <span class="copy-icon"></span>
        </button>
      </div>
    </div>

    <div class="workspace" id="tab-compress">
      <div class="pane">
        <textarea
          id="compress-input"
          oninput="
            processCompress();
            save();
          "
        ></textarea>
      </div>
      <div class="pane">
        <div class="output" id="compress-output"></div>
        <button class="copy-btn" onclick="copyOutput('compress-output')">
          <span class="copy-icon"></span>
        </button>
      </div>
    </div>

    <div class="toast" id="toast">скопировано</div>

    <script>
      let activeTab = "split";

      function switchTab(tab) {
        activeTab = tab;
        document.querySelectorAll(".tab").forEach((t, i) => {
          t.classList.toggle(
            "active",
            (i === 0 && tab === "split") || (i === 1 && tab === "compress"),
          );
        });
        document
          .getElementById("tab-split")
          .classList.toggle("active", tab === "split");
        document
          .getElementById("tab-compress")
          .classList.toggle("active", tab === "compress");
        localStorage.setItem("activeTab", tab);
      }

      function processSplit() {
        const input = document.getElementById("split-input").value;
        const result = input
          .split("\n")
          .map((line) => {
            if (!line.trim()) return "";
            let l = line.replace(
              /(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}:\d{5})(?=\d)/g,
              "$1 ",
            );
            l = l.replace(/(?<!\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}):/g, " ");
            l = l
              .replace(/[;|,\t]+/g, " ")
              .replace(/ +/g, " ")
              .trim();
            return l;
          })
          .join("\n");
        document.getElementById("split-output").textContent = result;
      }

      function detectType(line) {
        if (/@\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}/.test(line)) return "proxy";
        if (/^\d{4}/.test(line)) return "card";
        return "email";
      }

      function processCompress() {
        const input = document.getElementById("compress-input").value;
        const lines = input
          .split("\n")
          .map((l) => l.trim())
          .filter(Boolean);
        const emails = lines.filter((l) => detectType(l) === "email");
        const proxies = lines.filter((l) => detectType(l) === "proxy");
        const cards = lines.filter((l) => detectType(l) === "card");
        const count = Math.max(emails.length, proxies.length, cards.length);
        const out = [];
        for (let i = 0; i < count; i++) {
          let row = "";
          if (emails[i]) row += emails[i];
          if (proxies[i]) row += proxies[i];
          if (cards[i]) row += (row ? " " : "") + cards[i];
          if (row) out.push(row);
        }
        document.getElementById("compress-output").textContent = out.join("\n");
      }

      function copyOutput(id) {
        navigator.clipboard
          .writeText(document.getElementById(id).textContent)
          .then(() => {
            const t = document.getElementById("toast");
            t.classList.add("show");
            setTimeout(() => t.classList.remove("show"), 1800);
          });
      }

      function save() {
        localStorage.setItem(
          "split-input",
          document.getElementById("split-input").value,
        );
        localStorage.setItem(
          "compress-input",
          document.getElementById("compress-input").value,
        );
      }

      function load() {
        const si = localStorage.getItem("split-input");
        const ci = localStorage.getItem("compress-input");
        const tab = localStorage.getItem("activeTab") || "split";
        if (si) document.getElementById("split-input").value = si;
        if (ci) document.getElementById("compress-input").value = ci;
        switchTab(tab);
        processSplit();
        processCompress();
      }

      load();
    </script>
  </body>
</html>
